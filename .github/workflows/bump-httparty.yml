name: Bump httparty (security)

on:
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  bump:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true

      - name: Unfreeze lockfile
        run: bundle config set frozen false

      - name: Show current httparty and who pulls it in
        run: |
          bundle info httparty || true
          bundle why httparty || true

      - name: Try updating httparty
        run: |
          set -euxo pipefail
          bundle update httparty || true
          grep -n "httparty (" Gemfile.lock || true

      - name: Create PR if lockfile changed
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Bump httparty (security)"
          title: "Bump httparty (security)"
          body: |
            Attempt to upgrade HTTParty to a patched version.
            The workflow logs include `bundle why httparty` to identify any pinning dependency.
          branch: "deps/bump-httparty"
